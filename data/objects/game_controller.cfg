{
	id: "game_controller",
	is_strict: true,
	is_human: true,
	always_active: true,
	hidden_in_game: true,

	prototype: ["game_controller_base"],

	properties: {
		myplayer: { type: "int", default: 0 },

		characters: { type: "[obj character]", default: [] },

		present_animation_blocking: "def(class animation anim) ->commands
		if(anim is class animation.move_unit,
			_animate_move(anim)
		)
		",		

		_animate_move: "def(class animation.move_unit anim) ->commands

		if(u != null,
			map(anim.path[1:],
				u.walk_to_tile_blocking(value)
			)
		)
		
		where u = find(characters, value.unit_info._uuid = anim.unit._uuid)
		",

		present_game_state: "def() ->commands
		[
			[remove_object(c) | c <- characters, find(state.units, value._uuid = c.unit_info._uuid) = null];
			set(characters, [c | c <- characters, find(state.units, value._uuid = c.unit_info._uuid) != null]);

			map(characters, value.unit_info_updated());

			[spawn(c.id, {
				_unit_info: c,
				game_controller: me,
			}, [
				add(characters, [child]),
				child.unit_info_updated(),
			] asserting child is obj character)
			| c <- state.units, find(characters, value.unit_info._uuid = c._uuid) = null],


		]
		",

		_selected_character: { type: "null|obj character" },
		_tile_highlights: { type: "[obj tile_highlight]", default: [] },

		clear_selected_character: "def() ->commands
		[
			set(_selected_character, null),
			map(_tile_highlights, remove_object(value)),
			set(_tile_highlights, []),
		]
		",

		highlight_tiles: "def([Loc] locs) ->commands
			map(locs,
				spawn('tile_highlight', {
					zorder: 100,
					x: value.x*TILE_DIM,
					y: value.y*TILE_DIM,
					loc: value,
					handle_click: tile_clicked,
				}, [
					add(_tile_highlights, [child]),
				])
			)
		",

		tile_clicked: "def(Loc loc) ->commands
		if(_selected_character != null,
		[
			clear_selected_character(),
			send({
				type: 'move_unit',
				unit_id: _selected_character.unit_info._uuid,
				dst: loc,
			}),
		]
		)
		",

		character_clicked: "def(obj character c) ->commands [
			clear_selected_character(),
			set(_selected_character, c),

			highlight_tiles(lib.pathfind.possible_moves(state, c.unit_info)),

		]
		",

		character_right_clicked: "def(obj character c) ->commands
			null
		",
	},

	events: {
		create: "
		let characters = filter(level.chars, value is obj character);
		map(characters, remove_object(value));
		schedule(1, ;
		send({
			type: 'setup_characters',
			characters: [{
				id: c.type,
				loc: c.calculate_loc,
				side: 0,
			} | c <- characters],
		})
		)
		",
	},
}
